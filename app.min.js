!function(){"use strict";angular.module("app",[])}(),function(e){var t=["$scope","getDataService",function(e,t){e.createAccount=function(){var t=e.expCalc.accounts,n=t.length,a={settings:{accountCurrency:e.expCalc.settings.baseCurrency,fixationDirectly:!0},meta:{title:"Новый расчет "+n,total:0,fullRefund:0,negBalance:0,posBalance:0,negBalanceByBank:0,posBalanceByBank:0,bank:0},participants:[]};t.push(a),e.expCalc.settings.currentAccount=n,e.createParticipant()},e.createParticipant=function(){var t=e.expCalc.accounts[e.expCalc.settings.currentAccount],n=t.participants.length,a={meta:{title:"Участник "+e.expCalc.settings.currentAccount+"."+n,participation:1,preferredCurrency:t.settings.accountCurrency,total:0,share:0,balance:0,receivedSum:0,givenSum:0,fullBalance:0,fullBalanceByBank:0},expenses:[],fixation:{whom:[],byBank:[],reserve:0}};t.participants.push(a),e.addParticipantToPartList()},e.removeExpensesType=function(t){var n=e.isExpensesTypeUsed(t);n?alert(n):(e.expCalc.accounts.forEach(function(e,n,a){e.participants.forEach(function(e,n,a){e.expenses.forEach(function(e,n,a){e.type>t&&(e.type=(e.type-1).toString())})})}),e.expCalc.settings.expensesTypes.splice(t,1))},e.removeCurrency=function(t){var n=e.isCurrencyUsed(t);n?alert(n):(e.expCalc.settings.baseCurrency>t&&(e.expCalc.settings.baseCurrency=(e.expCalc.settings.baseCurrency-1).toString()),e.expCalc.accounts.forEach(function(e,n,a){e.settings.accountCurrency>t&&(e.settings.accountCurrency=(e.settings.accountCurrency-1).toString()),e.participants.forEach(function(e,n,a){e.meta.preferredCurrency>t&&(e.meta.preferredCurrency=(e.meta.preferredCurrency-1).toString()),e.expenses.forEach(function(e,n,a){e.currency>t&&(e.currency=(e.currency-1).toString())}),e.fixation.whom.forEach(function(e,n,a){e.currency>t&&(e.currency=(e.currency-1).toString())})})}),e.expCalc.settings.currencies.names.splice(t,1),e.expCalc.settings.currencies.rates.splice(t,1),e.expCalc.settings.currencies.rates.forEach(function(e,n,a){e.splice(t,1)}))},e.removeCurrentAccount=function(){e.expCalc.accounts.splice(e.expCalc.settings.currentAccount,1)},e.removeParticipant=function(t){var n=e.expCalc.settings.currentAccount,a=e.werePaymentsFromParticipant(t);a?alert(a):(e.expCalc.accounts[n].participants.splice(t,1),e.removeParticipantFromPartList(t))},e.removeExpense=function(t,n){var a=e.expCalc.settings.currentAccount;e.expCalc.accounts[a].participants[t].expenses.splice(n,1)},e.removeParticipantFromPartList=function(t){e.expCalc.accounts[e.expCalc.settings.currentAccount].participants.forEach(function(e,n,a){e.expenses.forEach(function(e,n,a){e.partList.splice(t,1)})})},e.removePayment=function(e,t){e.fixation.whom.splice(t,1)},e.removePaymentByBank=function(e,t){e.fixation.byBank.splice(t,1)},e.addNewExpensesType=function(){e.expCalc.settings.expensesTypes.push({name:"",icon:""})},e.addNewCurrency=function(){var t=[];e.expCalc.settings.currencies.names.push(""),e.expCalc.settings.currencies.rates.forEach(function(e,n,a){e.push(null),t.push(null)}),t.push(null),e.expCalc.settings.currencies.rates.push(t)},e.addNewExpense=function(t,n){var a=e.expCalc.accounts[e.expCalc.settings.currentAccount],c=e.expCalc.settings.currentAccount,r={title:"Расход "+c+"."+n+"."+t.expenses.length,type:"0",date:""+new Date,value:null,currency:a.settings.accountCurrency,isPaid:!1,partList:[]};e.expCalc.accounts[c].participants.forEach(function(e,t,n){r.partList.push(!0)}),t.expenses.push(r)},e.addParticipantToPartList=function(){e.expCalc.accounts[e.expCalc.settings.currentAccount].participants.forEach(function(e,t,n){e.expenses.forEach(function(e,t,n){e.partList.push(!0)})})},e.addValueToParticipationLists=function(t,n){e.expCalc.accounts[t].participants.forEach(function(e,t,a){e.participationList[n].push({value:!0,share:null})})},e.addNewPayment=function(e){e.fixation.whom.push({number:null,value:null,currency:null,date:""+new Date,isFixed:!1})},e.addNewPaymentByBank=function(t,n){var a=e.expCalc.accounts[e.expCalc.settings.currentAccount],c=a.meta.bank<t.meta.fullBalanceByBank?a.meta.bank:t.meta.fullBalanceByBank,r=n>0?c:t.meta.fullBalanceByBank<0?-t.meta.fullBalanceByBank:null;if(r<0&&(r=null),1==n&&0==a.meta.bank)return alert("Банк пуст и вы ничего не сможете получить"),!1;t.fixation.byBank.push({token:n,value:r,date:""+new Date,isFixed:!1})},e.getAccountCurrency=function(){var t=e.expCalc.accounts[e.expCalc.settings.currentAccount];return e.expCalc.settings.currencies.names[t.settings.accountCurrency].toUpperCase()},e.getAccountTotal=function(){var t=e.expCalc.accounts[e.expCalc.settings.currentAccount];return t.meta.total=0,t.participants.forEach(function(e,n,a){t.meta.total+=e.meta.total}),t.meta.total=e.exact(t.meta.total),e.exact(t.meta.total)},e.getParticipantTotal=function(t){var n=e.expCalc.accounts[e.expCalc.settings.currentAccount],a=e.expCalc.settings.currencies.rates[n.settings.accountCurrency];return t.meta.total=0,t.expenses.forEach(function(e,n,c){e.isPaid&&(t.meta.total+=e.value*a[e.currency])}),t.meta.total},e.getMoneyByAccountCurrency=function(t,n){var a=e.expCalc.accounts[e.expCalc.settings.currentAccount];return t*e.expCalc.settings.currencies.rates[a.settings.accountCurrency][n]},e.getMoneyByPrefferedCurrency=function(t,n){var a=e.expCalc.accounts[e.expCalc.settings.currentAccount];return t/e.expCalc.settings.currencies.rates[a.settings.accountCurrency][n]},e.getExpenseWithRate=function(t){return e.getMoneyByAccountCurrency(t.value,t.currency)},e.getPartSumOfExpense=function(t){var n=e.expCalc.accounts[e.expCalc.settings.currentAccount],a=0;return t.partList.forEach(function(e,t,c){e&&(a+=n.participants[t].meta.participation)}),a},e.getExpenseShare=function(t,n){var a=e.expCalc.accounts[e.expCalc.settings.currentAccount];if(t.isPaid)return t.partList[n]*a.participants[n].meta.participation*e.getExpenseWithRate(t)/e.getPartSumOfExpense(t)},e.getParticipantShare=function(t){var n,a=e.expCalc.accounts[e.expCalc.settings.currentAccount],c=0,r=[];return e.expCalc.settings.expensesTypes.forEach(function(e,t,n){r.push(0)}),a.participants.forEach(function(a,u,i){a.expenses.forEach(function(a,u,i){a.isPaid&&(n=e.getExpenseShare(a,t),c+=n,r[a.type]+=n)})}),r.forEach(function(t,n,a){a[n]=e.roundOff(t)}),a.participants[t].meta.expensesByTypes=r,a.participants[t].meta.share=e.exact(c),c},e.getShareTotal=function(){var t=e.expCalc.accounts[e.expCalc.settings.currentAccount],n=0;return t.participants.forEach(function(e,a,c){n+=t.participants[a].meta.share}),n},e.getFullRefund=function(){var t,n=e.expCalc.accounts[e.expCalc.settings.currentAccount],a=0;return n.participants.forEach(function(e,n,c){t=e.meta.total-e.meta.share,a+=t<0?t:0}),n.meta.fullRefund=e.exact(a),a},e.getBalance=function(t){return t.meta.balance=e.exact(t.meta.total-t.meta.share),t.meta.balance},e.getParticipantOption=function(t,n){var a,c=t.meta.title;return n.meta.balance<0&&e.roundOff(t.meta.balance-t.meta.receivedSum)>0&&e.roundOff(n.meta.balance+n.meta.givenSum)<0&&(a=e.getRest(t,n).currency,c+=" - ["+e.expCalc.settings.currencies.names[a].toUpperCase()+" "+e.getRest(t,n).rest+"]"),c},e.getReceivedSum=function(t,n){var a=e.expCalc.accounts[e.expCalc.settings.currentAccount];return t.meta.receivedSum=0,a.participants.forEach(function(a,c,r){a.fixation.whom.forEach(function(a,c,r){a.isFixed&&n==a.number&&null!==a.number&&null!==a.currency&&(t.meta.receivedSum+=e.roundOff(e.getMoneyByAccountCurrency(a.value,a.currency),!0))})}),t.meta.receivedSum=e.roundOff(t.meta.receivedSum),t.meta.receivedSum},e.getGivenSum=function(t){return t.meta.givenSum=0,t.fixation.whom.forEach(function(n,a,c){n.isFixed&&null!==n.number&&null!==n.currency&&(t.meta.givenSum+=e.roundOff(e.getMoneyByAccountCurrency(n.value,n.currency),!0))}),t.meta.givenSum=e.roundOff(t.meta.givenSum),t.meta.givenSum},e.getRest=function(t,n){var a,c,r,u,i=e.expCalc.accounts[e.expCalc.settings.currentAccount].settings.accountCurrency,s=t.meta.preferredCurrency!=i;return a=t.meta.balance-t.meta.receivedSum,c=Math.abs(n.meta.balance+n.meta.givenSum),u=a-c>0?c:a,r=e.getMoneyByPrefferedCurrency(u,t.meta.preferredCurrency),r=r<1?0:e.roundOff(r,s),{rest:0==r?e.roundOff(u):r,currency:0==r?i:t.meta.preferredCurrency}},e.getParticipantFullBalance=function(t,n,a){e.expCalc.accounts[e.expCalc.settings.currentAccount];var c=e.roundOff(t.meta.balance)-e.getReceivedSum(t,n)+e.getGivenSum(t),r=e.roundOff(c),u=e.getMoneyByPrefferedCurrency(c,t.meta.preferredCurrency);return t.meta.fullBalance=r,a?e.roundOff(u,!0):r},e.getReturnsBalance=function(t){var n,a=0,c=0,r=e.expCalc.accounts[e.expCalc.settings.currentAccount];return r.participants.forEach(function(e,r,u){(n="byBank"==t?e.meta.fullBalanceByBank:e.meta.fullBalance)>0?a+=n:c+=n}),"byBank"==t?(r.meta.negBalanceByBank=e.roundOff(c),r.meta.posBalanceByBank=e.roundOff(a),r.meta.negBalanceByBank+" / "+r.meta.posBalanceByBank):(r.meta.negBalance=e.roundOff(c),r.meta.posBalance=e.roundOff(a),r.meta.negBalance+" / "+r.meta.posBalance)},e.getAccountBank=function(){var t=e.expCalc.accounts[e.expCalc.settings.currentAccount],n=0;return t.participants.forEach(function(e,t,a){e.fixation.byBank.forEach(function(e,t,a){e.isFixed&&(n+=-1*e.token*e.value)})}),t.meta.bank=e.roundOff(n),t.meta.bank},e.getParticipantFullBalanceByBank=function(t){var n=0;return t.fixation.byBank.forEach(function(e,t,a){e.isFixed&&(n+=e.token*e.value)}),t.meta.fullBalanceByBank=e.roundOff(t.meta.balance-n),t.meta.fullBalanceByBank},e.exact=function(e){return Math.round(1e9*e)/1e9},e.roundOff=function(t,n){return void 0===t?0:t>9999999999?(console.error("The value is very long:",t),0):(t=e.exact(t),n?Math.floor(100*t)/100:Math.round(100*t)/100)},e.fillRefundFields=function(t,n){var a=e.expCalc.accounts[e.expCalc.settings.currentAccount].participants[n.number],c=e.getRest(a,t).rest;n.value=t.meta.fullBalance<0&&c>0?c:null,n.currency=e.getRest(a,t).currency},e.formatDate=function(e){return e?(e=new Date(e)).toLocaleString():""},e.isAllRefundsFixed=function(e){var t=!0;return e.fixation.whom.forEach(function(e,n,a){t=t&&e.isFixed}),t},e.checkRefundFields=function(e){null!=e.number&&null!=e.value&&null!=e.currency||(e.isFixed=!1)},e.checkPartList=function(e,t){var n=!1;e.forEach(function(e,t,a){n=n||e}),n||(e[t]=!0,alert("Нельзя отменить участие в одном и том же расходе для всех участников"))},e.isExpensesTypeUsed=function(t){var n,a,c,r,u="",i=[],s=[],o=e.expCalc.settings.expensesTypes[t].name;return e.expCalc.accounts.forEach(function(e,u,l){a="\n[ "+e.meta.title+"; ",e.participants.forEach(function(e,u,l){c=e.meta.title+" ]\n",s=[],r='- Тип "'+o+'" используется в расходах:\n',e.expenses.forEach(function(e,n,a){e.type==t&&s.push(e.title)}),s.length&&(n=a+c+r+s.join("; "),i.push(n))})}),i.length&&(u='Тип "'+o+'" не может быть удален по следующим причинам:\n'+i.join("\n")),u},e.isCurrencyUsed=function(t){var n,a,c,r,u,i,s="",o=[],l=[],p=e.expCalc.settings.currencies.names[t].toUpperCase();return e.expCalc.accounts.forEach(function(e,n,a){t==e.settings.accountCurrency&&l.push(e.meta.title)}),l.length&&(s="Валюта "+p+" используется как основная в расчетах:\n",s+=l.join("; "),s+="\n"),e.expCalc.accounts.forEach(function(e,s,f){a="\n[ "+e.meta.title+"; ",e.participants.forEach(function(e,s,f){c=e.meta.title+" ]\n",l=[],r="",u="",i="- Валюта "+p+" используется в расходах:\n",e.meta.preferredCurrency==t&&(r="- Предпочитает валюту "+p+"\n"),e.fixation.whom.forEach(function(e,n,a){e.currency==t&&(u="- Вернул долг напрямую в валюте "+p+"\n")}),e.expenses.forEach(function(e,n,a){e.currency==t&&l.push(e.title)}),(r||u||l.length)&&(n=a+c+r+u,l.length&&(n+=i+l.join("; ")),o.push(n))})}),(s||o.length)&&(s="Валюта "+p+" не может быть удалена по следующим причинам:\n"+s+o.join("\n")),s},e.werePaymentsFromParticipant=function(t){var n=e.expCalc.accounts[e.expCalc.settings.currentAccount],a=n.participants[t],c=!1,r="",u="",i="";return n.participants.forEach(function(e,n,c){n==t&&e.fixation.whom.length&&(r="- "+e.meta.title+" сделал взносы (расчет напрямую);\n"),e.fixation.whom.forEach(function(n,c,r){n.number==t&&(u+="- "+a.meta.title+" получил взнос от "+e.meta.title+";\n")})}),n.participants.forEach(function(e,n,a){n==t&&e.fixation.byBank.length&&(i="- "+e.meta.title+" участвует в расчетах через общий банк;\n")}),(r||u)&&(c="Невозможно удалить участника по следующим причинам:\n"+r+u+i),c},e.checkPaymentByBank=function(t){var n=e.expCalc.accounts[e.expCalc.settings.currentAccount];t.isFixed&&(t.value<=0&&(t.isFixed=!1,alert("Значение должно быть положительным")),t.token>0&&t.value>n.meta.bank&&(t.isFixed=!1,alert("В банке "+n.meta.bank+" "+e.getAccountCurrency()+", сейчас вы можете получить только этот максимум"),t.value=n.meta.bank))},e.today=function(){return e.formatDate(""+new Date)},e.$watch("expCalc",function(e,t){localStorage.setItem("expensesCalc",JSON.stringify(e)),document.getElementById("testing").innerHTML=JSON.stringify(e).replace(/\[/g,"[<div>").replace(/]/g,"</div>]").replace(/{/g,"{<div>").replace(/}/g,"</div>}").replace(/,/g,",<hr>").replace(/:/g,": ").replace(/},<hr>{/g,"},{").replace(/],<hr>\[/g,"],[").replace(/],\[/g,"<ar>],[</ar>").replace(/},{/g,"<arr>},{</arr>").replace(/Участник/g,"<b>Участник</b>").replace(/"participants": \[/g,'<b>"participants": [</b>').replace(/"currencies": {<div>/g,"\"currencies\": {<div class='compressed'>").replace(/"expensesTypes": \[<div>/g,"\"expensesTypes\": [<div class='compressed'>"),document.getElementById("testing").querySelectorAll("div").forEach(function(e,t){e.addEventListener("click",function(e){e.stopPropagation(),e.target.classList.toggle("compressed")})})},!0),e.copyObjectToBuffer=function(){var e=document.getElementById("angularObject"),t=document.createRange();t.selectNode(e);var n=window.getSelection();n.addRange(t);try{var a=document.execCommand("copy")?"УСПЕШНО":"ПЛОХО!!!",c=n.toString();a=c.length?a:"неудачно. Повторите попытку копирования",alert("Объект скопировался "+a+": "+c)}catch(e){alert("Проблема с копированием")}window.getSelection().removeAllRanges(),n.removeAllRanges()},console.log(e),e.expCalc=t,e.expCalc.accounts.length||e.createAccount()}];e.controller("calculatorCtrl",t)}(angular.module("app")),angular.module("app").factory("getDataService",function(){var e;return localStorage.getItem("expensesCalc")?e=JSON.parse(localStorage.getItem("expensesCalc")):(e={settings:{currentAccount:0,currencies:{names:["usd","eur","rub","byn"],rates:[[1,1.1934,.0174,.5186],[.8379,1,.0146,.4345],[57.322,68.4158,1,29.7271],[1.928,2.2963,.0336,1]]},baseCurrency:"3",expensesTypes:[{name:"Общие расходы",icon:""},{name:"Продукты питания",icon:""},{name:"Жильё",icon:""},{name:"Машина",icon:""},{name:"Развлечение",icon:""}]},accounts:[]},localStorage.setItem("expensesCalc",JSON.stringify(e))),e});